---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Navigation from '@/components/Navigation.astro';
import { getPosts, BLOG_CATEGORIES, formatDate, type NotionPost } from '@/lib/notion';

const title = 'ブログ | TechTime株式会社';
const description = 'TechTimeの最新情報や技術ブログをお届けします。AI駆動開発、システム開発のノウハウなど、役立つ情報を発信中。';

// Fetch posts from Notion at build time
const notionPosts = await getPosts({ perPage: 20 });

// Sort by date (newest first)
const allPosts = notionPosts.sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
---

<BaseLayout title={title} description={description}>
  <Navigation currentPath="/blog" />

  <div class="min-h-screen bg-gradient-to-br from-[#0A1628] via-[#0D1B2E] to-[#0A1628]">
    <div class="pt-20 sm:pt-24 lg:pt-32 pb-12 sm:pb-16 px-4 sm:px-6">
      <div class="max-w-7xl mx-auto">
        <div class="text-center mb-8">
          <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-white mb-4">ブログ</h1>
          <p class="text-gray-300 text-sm sm:text-base">TechTimeの最新情報や技術ブログをお届けします</p>
        </div>

        <!-- Category Filter -->
        <div class="flex flex-wrap gap-3 justify-center mb-12" id="category-filter">
          <button data-category="" class="category-btn active px-4 py-2 rounded-full text-sm font-medium bg-[#00D9FF] text-[#0A1628]">すべて</button>
          {Object.values(BLOG_CATEGORIES).map((cat) => (
            <button data-category={cat.slug} class="category-btn px-4 py-2 rounded-full text-sm font-medium bg-white/10 text-gray-300 hover:bg-white/20 transition-all">
              {cat.name}
            </button>
          ))}
        </div>

        <!-- Blog Posts Grid -->
        <div id="posts-container">
          {allPosts.length === 0 ? (
            <div class="text-center py-20">
              <i class="ri-article-line text-6xl text-gray-600 mb-4"></i>
              <p class="text-gray-400">記事が見つかりませんでした</p>
            </div>
          ) : (
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="posts-grid">
              {allPosts.map((post) => (
                <a
                  href={`/blog/${post.slug}`}
                  class="post-card group bg-white/5 backdrop-blur-xl rounded-2xl border border-white/10 overflow-hidden hover:border-[#00D9FF]/50 transition-all duration-300 hover:-translate-y-1"
                  data-category={post.category || ''}
                >
                  {post.coverImage && (
                    <div class="aspect-video overflow-hidden bg-white/5">
                      <img src={post.coverImage} alt={post.title} class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" loading="lazy" />
                    </div>
                  )}
                  <div class="p-6">
                    <div class="flex items-center gap-3 mb-3">
                      <span class="text-xs text-gray-400">{formatDate(post.createdAt)}</span>
                      {post.category && BLOG_CATEGORIES[post.category] && (
                        <span class="px-2 py-1 text-xs rounded-full bg-[#00D9FF]/10 text-[#00D9FF]">
                          {BLOG_CATEGORIES[post.category].name}
                        </span>
                      )}
                    </div>
                    <h3 class="text-lg font-bold text-white mb-3 group-hover:text-[#00D9FF] transition-colors line-clamp-2">{post.title}</h3>
                    <p class="text-sm text-gray-400 line-clamp-3">{post.excerpt || post.content.substring(0, 150) + '...'}</p>
                    <div class="mt-4 flex items-center text-[#00D9FF] text-sm font-medium">
                      <span>続きを読む</span>
                      <i class="ri-arrow-right-line ml-1 group-hover:translate-x-1 transition-transform"></i>
                    </div>
                  </div>
                </a>
              ))}
            </div>
          )}
        </div>

        <!-- Empty State (hidden by default) -->
        <div id="empty-state" class="hidden text-center py-20">
          <i class="ri-article-line text-6xl text-gray-600 mb-4"></i>
          <p class="text-gray-400">このカテゴリの記事はありません</p>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  // Category filtering
  document.addEventListener('DOMContentLoaded', () => {
    const buttons = document.querySelectorAll('.category-btn');
    const cards = document.querySelectorAll('.post-card');
    const emptyState = document.getElementById('empty-state');
    const postsGrid = document.getElementById('posts-grid');

    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        const category = btn.getAttribute('data-category');

        // Update button styles
        buttons.forEach(b => {
          b.classList.remove('active', 'bg-[#00D9FF]', 'text-[#0A1628]');
          b.classList.add('bg-white/10', 'text-gray-300');
        });
        btn.classList.add('active', 'bg-[#00D9FF]', 'text-[#0A1628]');
        btn.classList.remove('bg-white/10', 'text-gray-300');

        // Filter cards
        let visibleCount = 0;
        cards.forEach(card => {
          const cardCategory = card.getAttribute('data-category');
          if (!category || cardCategory === category) {
            (card as HTMLElement).style.display = '';
            visibleCount++;
          } else {
            (card as HTMLElement).style.display = 'none';
          }
        });

        // Show/hide empty state
        if (emptyState && postsGrid) {
          if (visibleCount === 0) {
            emptyState.classList.remove('hidden');
            postsGrid.classList.add('hidden');
          } else {
            emptyState.classList.add('hidden');
            postsGrid.classList.remove('hidden');
          }
        }

        // Update URL without reload
        const url = category ? `/blog?category=${category}` : '/blog';
        history.pushState({}, '', url);
      });
    });

    // Handle initial URL parameter
    const params = new URLSearchParams(window.location.search);
    const initialCategory = params.get('category');
    if (initialCategory) {
      const targetBtn = document.querySelector(`[data-category="${initialCategory}"]`);
      if (targetBtn) {
        (targetBtn as HTMLButtonElement).click();
      }
    }
  });
</script>
