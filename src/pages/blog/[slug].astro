---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Navigation from '@/components/Navigation.astro';
import { getPost, getAllPostSlugs, BLOG_CATEGORIES, formatDate, type TocItem } from '@/lib/notion';

export async function getStaticPaths() {
  const slugs = await getAllPostSlugs();
  return slugs.map((slug) => ({ params: { slug } }));
}

const { slug } = Astro.params;
const post = await getPost(slug as string);

if (!post) {
  return Astro.redirect('/blog');
}

const title = `${post.title} | TechTime株式会社`;
const description = post.excerpt || post.content.substring(0, 160);
---

<BaseLayout title={title} description={description} ogImage={post.coverImage}>
  <Navigation currentPath="/blog" />

  <div class="min-h-screen bg-white">
    <article class="pt-20 sm:pt-24 lg:pt-32 pb-16 sm:pb-24 px-4 sm:px-6">
      <div class="max-w-3xl mx-auto">
        <!-- Header -->
        <header class="mb-10">
          <div class="flex items-center gap-3 mb-6">
            <span class="text-sm text-gray-500 font-medium">{formatDate(post.createdAt)}</span>
            {post.category && BLOG_CATEGORIES[post.category] && (
              <span class="px-3 py-1 bg-[#00D9FF]/10 text-[#00D9FF] text-sm font-medium rounded-full">
                {BLOG_CATEGORIES[post.category].name}
              </span>
            )}
          </div>
          <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-gray-900 leading-tight">{post.title}</h1>
        </header>

        <!-- Cover Image -->
        {post.coverImage && (
          <div class="mb-12 rounded-xl overflow-hidden shadow-lg">
            <img src={post.coverImage} alt={post.title} class="w-full h-auto" />
          </div>
        )}

        <!-- Table of Contents -->
        {post.toc && post.toc.length > 0 && (
          <nav class="toc-container mb-12 p-6 bg-gray-50 rounded-xl border border-gray-200">
            <h2 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
              <i class="ri-list-unordered text-[#00D9FF]"></i>
              目次
            </h2>
            <ul class="toc-list space-y-2">
              {post.toc.map((item: TocItem) => (
                <li class={`toc-item toc-level-${item.level}`}>
                  <a href={`#${item.id}`} class="text-gray-600 hover:text-[#00D9FF] transition-colors">
                    {item.text}
                  </a>
                </li>
              ))}
            </ul>
          </nav>
        )}

        <!-- Content -->
        <div class="blog-content"
          set:html={post.content} />

        <!-- Back Link -->
        <div class="mt-16 pt-8 border-t border-gray-200">
          <a href="/blog" class="inline-flex items-center gap-2 text-[#00D9FF] hover:gap-3 transition-all duration-300">
            <i class="ri-arrow-left-line"></i>
            ブログ一覧に戻る
          </a>
        </div>
      </div>
    </article>
  </div>
</BaseLayout>

<style>
  /* Table of Contents */
  .toc-list {
    list-style: none !important;
    padding-left: 0 !important;
  }

  .toc-item {
    position: relative;
    padding-left: 1rem;
  }

  .toc-item::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0.6em;
    width: 6px;
    height: 6px;
    background: #00D9FF;
    border-radius: 50%;
  }

  .toc-level-2 {
    padding-left: 1.5rem;
  }

  .toc-level-2::before {
    width: 5px;
    height: 5px;
    background: #6b7280;
  }

  .toc-level-3 {
    padding-left: 2.5rem;
  }

  .toc-level-3::before {
    width: 4px;
    height: 4px;
    background: #9ca3af;
  }

  .toc-item a {
    text-decoration: none;
    line-height: 1.6;
    display: inline-block;
  }

  .toc-level-1 a {
    font-weight: 600;
    font-size: 0.95rem;
  }

  .toc-level-2 a {
    font-size: 0.9rem;
  }

  .toc-level-3 a {
    font-size: 0.85rem;
  }

  /* Blog Content */
  .blog-content {
    color: #1f2937 !important;
    font-size: 1.125rem !important;
    line-height: 2.2 !important;
    letter-spacing: 0.02em !important;
  }

  .blog-content p {
    margin-bottom: 2rem !important;
    color: #374151 !important;
    line-height: 2.2 !important;
  }

  .blog-content h1 {
    font-size: 2rem !important;
    font-weight: 800 !important;
    color: #111827 !important;
    margin-top: 3.5rem !important;
    margin-bottom: 1.5rem !important;
    padding-bottom: 0.75rem !important;
    border-bottom: 3px solid #00D9FF !important;
    line-height: 1.4 !important;
  }

  .blog-content h2 {
    font-size: 1.5rem !important;
    font-weight: 700 !important;
    color: #111827 !important;
    margin-top: 3rem !important;
    margin-bottom: 1.25rem !important;
    padding-left: 1rem !important;
    border-left: 4px solid #00D9FF !important;
    line-height: 1.4 !important;
  }

  .blog-content h3 {
    font-size: 1.25rem !important;
    font-weight: 700 !important;
    color: #111827 !important;
    margin-top: 2.5rem !important;
    margin-bottom: 1rem !important;
    line-height: 1.4 !important;
  }

  .blog-content strong {
    color: #111827 !important;
    font-weight: 700 !important;
    background: linear-gradient(transparent 60%, #fef08a 60%) !important;
  }

  .blog-content ul,
  .blog-content ol {
    margin: 1.5rem 0 !important;
    padding-left: 1.5rem !important;
  }

  .blog-content li {
    margin-bottom: 1rem !important;
    color: #374151 !important;
    line-height: 2.2 !important;
    padding-left: 0.5rem !important;
  }

  .blog-content ul li {
    list-style-type: disc !important;
  }

  .blog-content ul li::marker {
    color: #00D9FF !important;
  }

  .blog-content ol li {
    list-style-type: decimal !important;
  }

  .blog-content ol li::marker {
    color: #00D9FF !important;
    font-weight: 600 !important;
  }

  .blog-content blockquote {
    border-left: 4px solid #00D9FF !important;
    padding: 1.25rem 1.5rem !important;
    margin: 2rem 0 !important;
    background: #f0f9ff !important;
    color: #374151 !important;
    font-style: normal !important;
    border-radius: 0 0.5rem 0.5rem 0 !important;
    line-height: 2.2 !important;
  }

  .blog-content a {
    color: #0891b2 !important;
    text-decoration: underline !important;
    text-underline-offset: 3px !important;
    text-decoration-color: #00D9FF !important;
  }

  .blog-content a:hover {
    color: #0e7490 !important;
    text-decoration-color: #0e7490 !important;
  }

  .blog-content code {
    background: #f3f4f6 !important;
    color: #0891b2 !important;
    padding: 0.2rem 0.4rem !important;
    border-radius: 0.25rem !important;
    font-size: 0.9em !important;
  }

  .blog-content pre {
    background: #1f2937 !important;
    color: #e5e7eb !important;
    padding: 1.5rem !important;
    border-radius: 0.75rem !important;
    overflow-x: auto !important;
    margin: 2rem 0 !important;
  }

  .blog-content pre code {
    background: transparent !important;
    color: inherit !important;
    padding: 0 !important;
  }

  .blog-content hr {
    border: none !important;
    border-top: 2px solid #e5e7eb !important;
    margin: 3rem 0 !important;
  }

  .blog-content figure {
    margin: 2.5rem 0 !important;
  }

  .blog-content figure img {
    border-radius: 0.75rem !important;
    width: 100% !important;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
  }

  .blog-content figcaption {
    text-align: center !important;
    color: #6b7280 !important;
    font-size: 0.875rem !important;
    margin-top: 0.75rem !important;
  }

  .blog-content .callout {
    display: flex !important;
    gap: 0.75rem !important;
    padding: 1.25rem 1.5rem !important;
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%) !important;
    border-radius: 0.75rem !important;
    margin: 2rem 0 !important;
    border: 1px solid #bae6fd !important;
  }

  .blog-content .callout-icon {
    font-size: 1.5rem !important;
    flex-shrink: 0 !important;
  }

  .blog-content .callout p {
    margin: 0 !important;
    line-height: 1.7 !important;
  }

  /* First paragraph after heading - no top margin */
  .blog-content h1 + p,
  .blog-content h2 + p,
  .blog-content h3 + p {
    margin-top: 0 !important;
  }

  /* Nested lists */
  .blog-content ul ul,
  .blog-content ol ol,
  .blog-content ul ol,
  .blog-content ol ul {
    margin-top: 0.5rem !important;
    margin-bottom: 0.5rem !important;
  }

  /* Tables if present */
  .blog-content table {
    width: 100% !important;
    border-collapse: collapse !important;
    margin: 2rem 0 !important;
  }

  .blog-content th,
  .blog-content td {
    border: 1px solid #e5e7eb !important;
    padding: 0.75rem 1rem !important;
    text-align: left !important;
  }

  .blog-content th {
    background: #f9fafb !important;
    font-weight: 600 !important;
    color: #111827 !important;
  }

  .blog-content tr:nth-child(even) {
    background: #f9fafb !important;
  }
</style>
