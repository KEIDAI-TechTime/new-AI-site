# お問い合わせフォーム連携セットアップガイド

このガイドでは、お問い合わせフォームのNotion連携とメール通知を設定する手順を説明します。

## 📋 概要

お問い合わせフォームから送信されたデータは以下の処理が行われます：

1. **Notionデータベースに自動追加** - リード管理として保存
2. **メール通知** - `kdm@techtime-link.com` に通知メール送信

---

## 🔧 必要なもの

- Notionアカウント
- Resendアカウント（無料プラン: 3,000通/月）
- Vercelプロジェクト（デプロイ済み）

---

## ステップ1: Notionデータベースの作成

### 1.1 新しいデータベースを作成

1. Notionを開く
2. 新しいページを作成
3. `/database` と入力してテーブルデータベースを選択
4. データベース名を「お問い合わせ管理」に変更

### 1.2 データベースのプロパティを設定

以下のプロパティ（列）を作成してください：

| プロパティ名 | タイプ | 説明 |
|------------|--------|------|
| 会社名 | タイトル | デフォルトで存在 |
| お名前 | テキスト | - |
| メールアドレス | メール | - |
| 電話番号 | テキスト | - |
| システム種別 | セレクト | オプション: 文書管理システム, 在庫管理システム, 顧客・販売管理システム, 購買・調達管理システム, 経営ダッシュボード（BI）, 生産管理システム, 倉庫・物流管理システム, 人事・給与システム, 原価・会計システム, その他 |
| 予算 | セレクト | オプション: 100万円未満, 100万円〜300万円, 300万円〜500万円, 500万円〜1000万円, 1000万円以上, 未定 |
| 希望納期 | セレクト | オプション: 1ヶ月以内, 2〜3ヶ月, 3〜6ヶ月, 6ヶ月以上, 未定 |
| お問い合わせ内容 | テキスト | - |
| ステータス | セレクト | オプション: 新規, 対応中, 完了 |
| 作成日時 | 作成日時 | 自動設定 |

### 1.3 データベースIDを取得

1. データベースページのURLをコピー
2. URLの形式: `https://www.notion.so/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx?v=...`
3. `?v=` の前の32文字がデータベースID

**例:**
```
URL: https://www.notion.so/workspace/a1b2c3d4e5f6g7h8i9j0k1l2m3n4?v=xxx
Database ID: a1b2c3d4e5f6g7h8i9j0k1l2m3n4
```

---

## ステップ2: Notion APIキーの取得

### 2.1 Integrationを作成

1. https://www.notion.so/my-integrations にアクセス
2. **+ New integration** をクリック
3. 以下を設定：
   - **Name**: `TechTime Contact Form`
   - **Associated workspace**: 使用するワークスペースを選択
   - **Type**: Internal
4. **Submit** をクリック
5. **Internal Integration Secret** をコピー（これがAPIキーです）

### 2.2 データベースに権限を付与

1. お問い合わせ管理データベースページを開く
2. 右上の **...** メニューをクリック
3. **Add connections** を選択
4. 作成した Integration (`TechTime Contact Form`) を選択
5. **Confirm** をクリック

---

## ステップ3: Resendアカウントの設定

### 3.1 アカウント作成

1. https://resend.com にアクセス
2. アカウントを作成（GitHubアカウントでサインアップ可能）
3. 無料プラン: 3,000通/月、100通/日

### 3.2 APIキーを取得

1. ダッシュボードで **API Keys** を選択
2. **Create API Key** をクリック
3. 名前を入力（例: `TechTime Production`）
4. **Full Access** を選択
5. APIキーをコピー（`re_` で始まる文字列）

### 3.3 ドメイン認証（オプション・推奨）

メールの送信元を `noreply@techtime-link.com` などにしたい場合：

1. Resendダッシュボードで **Domains** を選択
2. **Add Domain** をクリック
3. ドメイン（`techtime-link.com`）を入力
4. 表示されるDNSレコードをドメインのDNS設定に追加
5. 認証が完了したら、`api/contact.ts` の `from` フィールドを更新：

```typescript
from: 'TechTime お問い合わせ <noreply@techtime-link.com>',
```

**注意:** ドメイン認証しない場合は、`onboarding@resend.dev` から送信されます（機能は同じ）

---

## ステップ4: Vercelに環境変数を設定

### 4.1 Vercelダッシュボードで設定

1. https://vercel.com にアクセス
2. プロジェクト (`new-AI-site`) を選択
3. **Settings** → **Environment Variables** を開く
4. 以下の3つの環境変数を追加：

| Name | Value | Environment |
|------|-------|-------------|
| `NOTION_API_KEY` | `secret_xxxxx...` （ステップ2で取得） | Production, Preview, Development |
| `NOTION_DATABASE_ID` | `xxxxx...` （ステップ1で取得） | Production, Preview, Development |
| `RESEND_API_KEY` | `re_xxxxx...` （ステップ3で取得） | Production, Preview, Development |

### 4.2 再デプロイ

環境変数を追加したら、プロジェクトを再デプロイ：

1. **Deployments** タブを開く
2. 最新のデプロイメントの **...** メニューをクリック
3. **Redeploy** を選択

---

## ステップ5: 動作確認

### 5.1 テスト送信

1. https://new-ai-site.vercel.app/contact にアクセス
2. フォームに情報を入力して送信
3. 送信完了メッセージが表示されることを確認

### 5.2 Notionを確認

1. Notionのお問い合わせ管理データベースを開く
2. 新しいレコードが追加されていることを確認
3. ステータスが「新規」になっていることを確認

### 5.3 メールを確認

1. `kdm@techtime-link.com` の受信トレイを確認
2. 件名「【TechTime】新規お問い合わせが届きました」のメールを確認
3. メール本文に送信した情報が含まれていることを確認

---

## 🎨 Notionデータベースのカスタマイズ

### ビューの追加

**ステータス別ビュー:**
1. データベース右上の **+ Add a view** をクリック
2. **Board** を選択
3. **Group by** を「ステータス」に設定
4. カンバンボードスタイルで管理可能に

**フィルター設定:**
- 「新規」のみ表示
- 過去7日間のお問い合わせ
- 予算が500万円以上

### プロパティの追加

追加で便利なプロパティ：
- **担当者** (Person) - 対応者を割り当て
- **優先度** (Select) - 高/中/低
- **対応期限** (Date) - フォローアップ期限
- **メモ** (Text) - 内部メモ

---

## 🔍 トラブルシューティング

### フォーム送信後にエラーが表示される

1. **ブラウザのコンソールを確認**
   - F12キーを押して Developer Tools を開く
   - Console タブでエラーメッセージを確認

2. **Vercelのログを確認**
   - Vercelダッシュボード → プロジェクト → Functions
   - `/api/contact` のログを確認
   - エラーメッセージから原因を特定

### Notionにデータが追加されない

1. **APIキーが正しいか確認**
   - Vercelの環境変数を確認
   - `secret_` で始まる正しいキーか

2. **データベースIDが正しいか確認**
   - URLから正しく取得したか
   - ハイフンなし32文字か

3. **Connectionが設定されているか確認**
   - Notionデータベースで Integration が接続されているか

4. **プロパティ名が一致しているか確認**
   - `api/contact.ts` のプロパティ名
   - Notionデータベースのプロパティ名
   - **完全一致が必要**（スペースや全角/半角に注意）

### メールが届かない

1. **ResendのAPIキーが正しいか確認**
2. **Resendのダッシュボードでログを確認**
   - https://resend.com/emails
   - 送信履歴とエラーを確認
3. **迷惑メールフォルダを確認**
4. **送信制限に達していないか確認**
   - 無料プラン: 100通/日

### セレクトプロパティのエラー

Notionで以下のエラーが出る場合：
```
body failed validation: body.properties.システム種別.select.name should be one of ...
```

**原因:** セレクトプロパティのオプションが存在しない

**解決方法:**
1. Notionデータベースでプロパティを開く
2. オプションを追加（完全一致させる）
3. または `api/contact.ts` の値を変更

---

## 📊 運用のヒント

### 1. 自動化の追加

**Notionの自動化:**
- ステータスが「新規」→「対応中」に変更時、担当者に通知
- 7日間対応がない場合、リマインダー

**Zapier/Make.com連携:**
- お問い合わせ時にSlack通知
- Google Sheetsにバックアップ
- CRMツール（Salesforce, HubSpot等）と連携

### 2. レポート作成

Notionで以下の分析が可能：
- 月間お問い合わせ数の推移
- システム種別ごとの割合
- 予算帯の分布
- 対応完了までの平均日数

### 3. テンプレート返信

よくある質問への返信テンプレートをNotionに作成しておくと効率的です。

---

## 📝 メンテナンス

### 定期的な確認事項

- Resendの送信数（月間上限: 3,000通）
- Notionデータベースの容量
- エラーログの確認

### バックアップ

定期的にNotionデータベースをエクスポート：
1. データベースの **...** メニュー
2. **Export** → **CSV**
3. Google DriveやDropboxに保存

---

## 🆘 サポート

問題が解決しない場合：

1. **Vercelのログを確認**
2. **このガイドのトラブルシューティングを確認**
3. **開発者に連絡**

---

## 🎉 完了！

これでお問い合わせフォームの連携が完了しました。

**確認事項:**
- ✅ Notionデータベースが作成されている
- ✅ Notion APIキーが取得できている
- ✅ Resend APIキーが取得できている
- ✅ Vercelの環境変数が設定されている
- ✅ テスト送信が成功している
- ✅ Notionにデータが追加されている
- ✅ メール通知が届いている

すべて完了したら、実際の運用を開始できます！
